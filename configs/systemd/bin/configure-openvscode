#!/usr/bin/env bash
set -euo pipefail

mkdir -p /var/log/cmux

color=""
case "${VSCODE_THEME:-}" in
  dark)
    color="Default Dark Modern"
    ;;
  light)
    color="Default Light Modern"
    ;;
  system)
    color="Default Dark Modern"
    ;;
esac

# Base settings that should always be applied
BASE_SETTINGS=$(jq -n \
  --arg theme "$color" \
  '{
    "workbench.startupEditor": "none",
    "workbench.secondarySideBar.defaultVisibility": "hidden",
    "terminal.integrated.shellIntegration.enabled": false,
    "terminal.integrated.showTerminalConfigPrompt": false,
    "terminal.integrated.macOptionClickForcesSelection": true,
    "terminal.integrated.shell.linux": "/usr/bin/zsh",
    "terminal.integrated.shellArgs.linux": ["-l"],
    "terminal.integrated.defaultProfile.linux": "zsh",
    "terminal.integrated.profiles.linux": {
      "zsh": {
        "path": "/usr/bin/zsh",
        "args": ["-l"]
      }
    },
    "python.languageServer": "Pylance",
    "python.defaultInterpreterPath": "/usr/bin/python3",
    "git.openDiffOnClick": true,
    "scm.defaultViewMode": "tree",
    "git.showPushSuccessNotification": true,
    "git.autorefresh": true,
    "git.branchCompareWith": "main",
    "security.workspace.trust.enabled": false,
    "security.workspace.trust.startupPrompt": "never",
    "security.workspace.trust.untrustedFiles": "open",
    "security.workspace.trust.emptyWindow": false,
    "workbench.editor.restoreViewState": true,
    "workbench.editor.preserveOpenEditors": true,
    "window.restoreWindows": "preserve",
    "window.reopenFolders": "one",
    "editor.minimap.enabled": false,
    "files.autoSave": "afterDelay",
    "files.autoSaveDelay": 1000,
    "workbench.activityBar.visible": true,
    "workbench.statusBar.visible": true,
    "workbench.sideBar.location": "left"
  } + (if $theme != "" then {"workbench.colorTheme": $theme} else {} end)')

home="${HOME:-/root}"
user_base="${home}/.openvscode-server"
user_dir="${user_base}/data/User"
default_profile_dir="${user_base}/data/User/profiles/default-profile"
machine_dir="${user_base}/data/Machine"

mkdir -p "${user_dir}" "${default_profile_dir}" "${machine_dir}"

# Function to merge settings - preserves existing user settings and adds/updates base settings
merge_settings() {
  local target_file="$1"
  local base_settings="$2"

  if [[ -f "$target_file" ]] && [[ -s "$target_file" ]]; then
    # File exists and is not empty - merge base settings with existing (base settings take precedence for managed settings)
    local existing
    existing=$(cat "$target_file" 2>/dev/null || echo '{}')
    # Validate existing is valid JSON, otherwise use empty object
    if ! echo "$existing" | jq empty 2>/dev/null; then
      existing='{}'
    fi
    # Merge: existing settings first, then base settings on top (so base settings win for managed keys)
    printf '%s' "$existing" | jq --argjson base "$base_settings" '. * $base' > "$target_file"
  else
    # File doesn't exist or is empty - write base settings directly
    printf '%s' "$base_settings" > "$target_file"
  fi
}

merge_settings "${user_dir}/settings.json" "$BASE_SETTINGS"
merge_settings "${default_profile_dir}/settings.json" "$BASE_SETTINGS"
merge_settings "${machine_dir}/settings.json" "$BASE_SETTINGS"

# Ensure workspace state directory exists for UI state persistence
mkdir -p "${user_base}/data/User/workspaceStorage"
mkdir -p "${user_base}/data/User/globalStorage"
