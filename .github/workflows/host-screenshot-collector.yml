name: Host Screenshot Collector Sync

on:
  push:
    branches: [main]
    paths:
      - packages/host-screenshot-collector/**
      - .github/workflows/host-screenshot-collector.yml
  workflow_dispatch:

concurrency:
  group: host-screenshot-collector-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: "24"

jobs:
  build-and-sync:
    name: Build and Sync to Convex
    runs-on: ubuntu-latest
    environment: electron
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.2.21

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build screenshot collector
        working-directory: packages/host-screenshot-collector
        run: bun run build

      - name: Get version info
        id: version
        working-directory: packages/host-screenshot-collector
        run: |
          VERSION=$(node -p "require('./package.json').version")
          SHORT_SHA="${GITHUB_SHA:0:7}"
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          FULL_VERSION="${VERSION}-${TIMESTAMP}-${SHORT_SHA}"
          echo "version=${FULL_VERSION}" >> "$GITHUB_OUTPUT"
          echo "Version: ${FULL_VERSION}"

      - name: Sync to Convex
        env:
          VERSION: ${{ steps.version.outputs.version }}
          NEXT_PUBLIC_CONVEX_URL: ${{ secrets.NEXT_PUBLIC_CONVEX_URL }}
        run: |
          # Convert .convex.cloud to .convex.site for HTTP actions
          CONVEX_SITE_URL="${NEXT_PUBLIC_CONVEX_URL/.convex.cloud/.convex.site}"
          echo "Using Convex site URL: ${CONVEX_SITE_URL}"

          # Build release URL from repository and commit
          RELEASE_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA}"
          echo "Release URL: ${RELEASE_URL}"

          # Upload the file to Convex via HTTP endpoint
          curl -X POST "${CONVEX_SITE_URL}/api/host-screenshot-collector/sync" \
            -H "Content-Type: application/octet-stream" \
            -H "X-Version: ${VERSION}" \
            -H "X-Commit-SHA: ${GITHUB_SHA}" \
            -H "X-Is-Staging: false" \
            -H "X-Release-URL: ${RELEASE_URL}" \
            --data-binary @packages/host-screenshot-collector/dist/index.js \
            --fail-with-body
